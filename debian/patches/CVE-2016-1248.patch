commit d0b5138ba4bccff8a744c99836041ef6322ed39a
Author: Bram Moolenaar <Bram@vim.org>
Date:   Fri Nov 4 15:23:45 2016 +0100

    patch 8.0.0056
    Problem:    When setting 'filetype' there is no check for a valid name.
    Solution:   Only allow valid characters in 'filetype', 'syntax' and 'keymap'.

Tests adapated to work with 7.4.488 by James McCoy <jamessan@debian.org>
Tests adjusted to apply to 7.4.1689 -- sbeattie
CVE-2016-1248
---
 src/option.c                |   38 +++++++++++++++++++++++++++++--
 src/testdir/test_options.in |   53 ++++++++++++++++++++++++++++++++++++++++++++
 src/testdir/test_options.ok |   32 ++++++++++++++++++++++++++
 src/version.c               |    2 +
 4 files changed, 123 insertions(+), 2 deletions(-)

Index: b/src/option.c
===================================================================
--- a/src/option.c
+++ b/src/option.c
@@ -5701,6 +5701,21 @@ set_string_option_direct(
 }
 
 /*
+ * Return TRUE if "val" is a valid 'filetype' name.
+ * Also used for 'syntax' and 'keymap'.
+ */
+    static int
+valid_filetype(char_u *val)
+{
+    char_u *s;
+
+    for (s = val; *s != NUL; ++s)
+	if (!ASCII_ISALNUM(*s) && vim_strchr((char_u *)".-_", *s) == NULL)
+	    return FALSE;
+    return TRUE;
+}
+
+/*
  * Set global value for string option when it's a local option.
  */
     static void
@@ -6201,8 +6216,11 @@ did_set_string_option(
 #ifdef FEAT_KEYMAP
     else if (varp == &curbuf->b_p_keymap)
     {
-	/* load or unload key mapping tables */
-	errmsg = keymap_init();
+	if (!valid_filetype(*varp))
+	    errmsg = e_invarg;
+	else
+	    /* load or unload key mapping tables */
+	    errmsg = keymap_init();
 
 	if (errmsg == NULL)
 	{
@@ -7176,6 +7194,22 @@ did_set_string_option(
 	    errmsg = e_invarg;
     }
 #endif
+
+#ifdef FEAT_AUTOCMD
+    else if (gvarp == &p_ft)
+    {
+	if (!valid_filetype(*varp))
+	    errmsg = e_invarg;
+    }
+#endif
+
+#ifdef FEAT_SYN_HL
+    else if (gvarp == &p_syn)
+    {
+	if (!valid_filetype(*varp))
+	    errmsg = e_invarg;
+    }
+#endif
 
     /* Options that are a list of flags. */
     else
Index: b/src/testdir/test_options.in
===================================================================
--- a/src/testdir/test_options.in
+++ b/src/testdir/test_options.in
@@ -16,6 +16,59 @@ STARTTEST
 :set path-=bar
 :set path+=bar
 :$put =&path
+:function! TrySet(opt, val, exc)
+  :let caught = 'ok'
+  :try
+    :exe 'set '.a:opt.'='.a:val
+  :catch
+    :let caught = v:exception
+  :endtry
+  :$put =a:val.' exception? '.(caught =~ a:exc)
+:endfunction
+: " Test filetype valid
+:set ft=valid_name
+:$put ='ft valid_name? '.(&ft == 'valid_name')
+:set ft=valid-name
+:$put ='ft valid-name? '.(&ft == 'valid-name')
+:"
+:call TrySet('ft', 'wrong;name', 'E474:')
+:call TrySet('ft', 'wrong\\name', 'E474:')
+:call TrySet('ft', 'wrong\|name', 'E474:')
+:call TrySet('ft', 'wrong/name', 'E474:')
+:call TrySet('ft', "wrong\\\nname", 'E474:')
+:"
+:$put ='ft valid-name? '.(&ft == 'valid-name')
+:exe "set ft=trunc\x00name"
+:$put ='ft trunc? '.(&filetype == 'trunc')
+: " Test syntax valid
+:set syn=valid_name
+:$put ='syn valid_name? '.('valid_name' == &syntax)
+:set syn=valid-name
+:$put ='syn valid-name? '.('valid-name' == &syntax)
+:"
+:call TrySet('syn', 'wrong;name', 'E474:')
+:call TrySet('syn', "wrong\\\\name", 'E474:')
+:call TrySet('syn', "wrong\\|name", 'E474:')
+:call TrySet('syn', "wrong/name", 'E474:')
+:call TrySet('syn', "wrong\\\nname", 'E474:')
+:"
+:$put ='syn valid-name? '.('valid-name' == &syntax)
+:exe "set syn=trunc\x00name"
+:$put ='syn trunc? '.('trunc' == &syntax)
+: " Test keymap valid
+:call TrySet('kmp', "valid_name", 'E544:')
+:call TrySet('kmp', "valid_name", 'valid_name')
+:call TrySet('kmp', "valid-name", 'E544:')
+:call TrySet('kmp', "valid-name", 'valid-name')
+:"
+:call TrySet('kmp', "wrong;name", 'E474:')
+:call TrySet('kmp', "wrong\\\\name", 'E474:')
+:call TrySet('kmp', "wrong\\|name", 'E474:')
+:call TrySet('kmp', "wrong/name", 'E474:')
+:call TrySet('kmp', "wrong\\\nname", 'E474:')
+:"
+:call TrySet('kmp', "trunc\x00name", 'E544:')
+:call TrySet('kmp', "trunc\x00name", 'trunc')
 :/^result/,$w! test.out
 :qa!
 ENDTEST
Index: b/src/testdir/test_options.ok
===================================================================
--- a/src/testdir/test_options.ok
+++ b/src/testdir/test_options.ok
@@ -1,3 +1,35 @@
 result
 ok
 foo,,bar
+ft valid_name? 1
+ft valid-name? 1
+wrong;name exception? 1
+wrong\\name exception? 1
+wrong\|name exception? 1
+wrong/name exception? 1
+wrong\
+name exception? 1
+ft valid-name? 1
+ft trunc? 1
+syn valid_name? 1
+syn valid-name? 1
+wrong;name exception? 1
+wrong\\name exception? 1
+wrong\|name exception? 1
+wrong/name exception? 1
+wrong\
+name exception? 1
+syn valid-name? 1
+syn trunc? 1
+valid_name exception? 1
+valid_name exception? 1
+valid-name exception? 1
+valid-name exception? 1
+wrong;name exception? 1
+wrong\\name exception? 1
+wrong\|name exception? 1
+wrong/name exception? 1
+wrong\
+name exception? 1
+trunc exception? 1
+trunc exception? 1
Index: b/src/version.c
===================================================================
--- a/src/version.c
+++ b/src/version.c
@@ -4146,6 +4146,8 @@ static int included_patches[] =
 static char *(extra_patches[]) =
 {   /* Add your patch description below this line */
 /**/
+    "8.0.0056",
+/**/
     NULL
 };
 
